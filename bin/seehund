#!/usr/bin/env node

const assert = require('assert');
const { camelize } = require('inflection')
const program = require('caporal');
const createCommand = require('../cli/commands/create');
const createCoreCommand = require('../cli/commands/create-core-stack');
const destroyCommand = require('../cli/commands/destroy');
const deleteBucketCommand = require('../cli/commands/delete-bucket');
const destroyCoreCommand = require('../cli/commands/destroy-core-stack');
const destroyApiCommand = require('../cli/commands/destroy-api');
const listCommand = require('../cli/commands/list');
const showCommand = require('../cli/commands/show');
const envCommand = require('../cli/commands/env');
const installApiCommand = require('../cli/commands/install-api');
const buildAdminCommand = require('../cli/commands/build-admin');
const uploadAdminCommand = require('../cli/commands/upload-admin');
const createAdminUserCommand = require('../cli/commands/create-admin-user');

const { getApiUrl } = require('../cli/lib/get-config');
const { loadBlog } = require('../cli/lib/blog')

program
  .command('create_core', 'Create core resources for a new blog in the cloud.')
  .argument('<title>', 'The title of the blog.')
  .option('-n --name <name>',
          'Logical name of the blog. Defaults to "<TitleCamelCase>"')
  .option('-b --bucket-name <bucketName>',
          'S3 web bucket name. Default to auto generated.')
  .option('-r --region <region>',
          'AWS Region', undefined, 'us-east-1')
  .action((args, options, logger) => {
    console.log(args, options);

    const { title } = args;
    const { bucketName, stackName, region } = options;

    createCoreCommand({
      title,
      bucketName,
      region,
    }, (err, data) => {
      if(err) {
        console.log('Error creating stack');
        console.info(err)
      } else {
        console.log(`Created stack with id ${data.StackId}`)
      }
    });
  });

program
  .command('destroy_core', 'Destroy all cloud resources')
  .argument('<blogName>', 'Blog to destroy')
  .option('-r --region <region>',
          'AWS Region', undefined, 'us-east-1')
  .action((args, options, logger) => {
    const { blogName } = args;
    const { region } = options;
    destroyCoreCommand({blogName, region}, (err) => {
      if(err) {
        console.log('Error deleting stack')
      } else {
        console.log('Deleted stack')
      }
    });
  });

program
  .command('destroy_api', 'Destroy all cloud resources')
  .argument('<blogName>', 'Blog to destroy')
  .option('-r --region <region>',
          'AWS Region', undefined, 'us-east-1')
  .action((args, options, logger) => {
    const { blogName } = args;
    const { region } = options;
    destroyApiCommand({blogName, region}, (err) => {
      if(err) {
        console.log('Error deleting stack')
      } else {
        console.log('Deleted stack')
      }
    });
  });


program
  .command('create', 'Create a new blog in the cloud.')
  .argument('<title>', 'The title of the blog.')
  .option('-r --region <region>',
          'AWS Region', undefined, 'us-east-1')
  .action((args, options, logger) => {
    const { title } = args;
    const { region } = options;

    createCommand({
      title,
      region
    }, (err, data) => {
      if(err) {
        console.log('Error creating blog');
        console.log(err)
      } else {
        console.log('Error')
      }
    });
  })

program
  .command('list', 'List all Seehund blogs in AWS account and region')
  .option('-r --region <region>',
          'AWS Region', undefined, 'us-east-1')
  .action((args, options, logger) => {
    const { region } = options;
    listCommand({region});
  });

program
  .command('show', 'Show information about a seehund blog')
  .argument('<blogName>', 'Blog to show')
  .option('-r --region <region>',
          'AWS Region', undefined, 'us-east-1')
  .action((args, options, logger) => {
    const { blogName } = args;
    const { region } = options;
    showCommand({blogName, region});
  });

program
  .command('env', 'Output env variables for a blog')
  .argument('<blogName>', 'Blog to use')
  .option('-r --region <region>',
          'AWS Region', undefined, 'us-east-1')
  .action((args, options, logger) => {
    const { blogName } = args;
    const { region } = options;
    envCommand({blogName, region});
  });

program
  .command('show_api_url', 'Show information about a seehund blog')
  .argument('<blogName>', 'Blog to show')
  .option('-r --region <region>',
          'AWS Region', undefined, 'us-east-1')
  .action((args, options, logger) => {
    const { blogName } = args;
    const { region } = options;
    getApiUrl({blogName, region}, (err, apiUrl) => {
      if(err) {
        console.log('error getting api url')
        console.info(err);
      } else {
        console.log(`API URL: ${apiUrl}`)
      }
    });
  });


program
  .command('destroy_bucket', 'Destroy the web bucket')
  .argument('<blogName>', 'Blog to destroy')
  .option('-r --region <region>',
          'AWS Region', undefined, 'us-east-1')
  .action((args, options, logger) => {
    const { blogName } = args;
    const { region } = options;
    deleteBucketCommand({blogName, region}, (err) => {
      if(err) {
        console.log('Error deleting bucket')
      } else {
        console.log('Deleted bucket')
      }
    });
  });


program
  .command('destroy', 'Destroy all cloud resources')
  .argument('<blogName>', 'Blog to destroy')
  .option('-r --region <region>',
          'AWS Region', undefined, 'us-east-1')
  .action((args, options, logger) => {
    const { blogName } = args;
    const { region } = options;
    destroyCommand({blogName, region}, (err) => {
      if(err) {
        console.log('Error destroying blog')
      } else {
        console.log('Destroyed blog')
      }
    });
  });

program
  .command('install_api', 'Installs the API')
  .argument('<blogName>', 'Blog name to install')
  .option('-r --region <region>',
          'AWS Region', undefined, 'us-east-1')
  .action((args, options, logger) => {
    const { blogName } = args;
    const { region } = options;
    installApiCommand({blogName, region});
  });

program
  .command('build_admin', 'Builds the admin system with webpack, supplying cloud resource configuration')
  .argument('<blogName>', 'Blog name to build admin for')
  .option('-r --region <region>',
          'AWS Region', undefined, 'us-east-1')
  .action((args, options, logger) => {
    const { blogName } = args;
    const { region } = options;
    loadBlog({name: blogName, region}, (err, blog) => {
      if(err) {
        console.log(`Error loading blog: ${blogName}`);
        console.log(err);
        return;
      }
      console.info(blog);
      buildAdminCommand(blog, (err, stats) => {
        if(err) {
          console.log('Error building admin')
          console.log(err);
        } else {
          console.log('Built blog');
        }
      });
    });
  });

program
  .command('upload_admin', 'Uploads the admin system to the web bucket')
  .argument('<blogName>', 'Blog name to upload admin for')
  .option('-r --region <region>',
          'AWS Region', undefined, 'us-east-1')
  .action((args, options, logger) => {
    const { blogName } = args;
    const { region } = options;
    uploadAdminCommand({blogName, bucketName});
  });

program
  .command('create_admin_user', 'Uploads the admin system to the web bucket')
  .argument('<blogName>', 'Blog name to create admin user for')
  .option('-r --region <region>',
          'AWS Region', undefined, 'us-east-1')
  .action((args, options, logger) => {
    const { blogName } = args;
    const { region } = options;
    createAdminUserCommand({blogName, region}, (err, data) => {
      if(err) {
        console.log('Error creating admin user')
      } else {
        console.log('Created admin user')
      }
    });
  });


program.parse(process.argv)


