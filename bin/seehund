#!/usr/bin/env node

const assert = require('assert');
const { camelize } = require('inflection')
const program = require('caporal');
const createCommand = require('../commands/create');
const createCoreCommand = require('../commands/create-core-stack');
const destroyCommand = require('../commands/destroy');
const deleteBucketCommand = require('../commands/delete-bucket');
const destroyCoreCommand = require('../commands/destroy-core-stack');
const destroyApiCommand = require('../commands/destroy-api');
const listCommand = require('../commands/list');
const showCommand = require('../commands/show');
const installApiCommand = require('../commands/install-api');
const buildAdminCommand = require('../commands/build-admin');
const uploadAdminCommand = require('../commands/upload-admin');
const createAdminUserCommand = require('../commands/create-admin-user');

const { getApiUrl } = require('../commands/get-config');

program
  .command('create_core', 'Create core resources for a new blog in the cloud.')
  .argument('<title>', 'The title of the blog.')
  .option('-n --name <name>',
          'Logical name of the blog. Defaults to "<TitleCamelCase>"')
  .option('-b --bucket-name <bucketName>',
          'S3 web bucket name. Default to auto generated.')
  .option('-r --region <region>',
          'AWS Region', undefined, 'us-east-1')
  .action((args, options, logger) => {
    console.log(args, options);

    const { title } = args;
    const { bucketName, stackName, region } = options;

    createCoreCommand({
      title,
      bucketName,
      region,
    }, (err, data) => {
      if(err) {
        console.log('Error creating stack');
        console.info(err)
      } else {
        console.log(`Created stack with id ${data.StackId}`)
      }
    });
  });

program
  .command('destroy_core', 'Destroy all cloud resources')
  .argument('<blogName>', 'Blog to destroy')
  .option('-r --region <region>',
          'AWS Region', undefined, 'us-east-1')
  .action((args, options, logger) => {
    const { blogName } = args;
    const { region } = options;
    destroyCoreCommand({blogName, region}, (err) => {
      if(err) {
        console.log('Error deleting stack')
      } else {
        console.log('Deleted stack')
      }
    });
  });

program
  .command('destroy_api', 'Destroy all cloud resources')
  .argument('<blogName>', 'Blog to destroy')
  .option('-r --region <region>',
          'AWS Region', undefined, 'us-east-1')
  .action((args, options, logger) => {
    const { blogName } = args;
    const { region } = options;
    destroyApiCommand({blogName, region}, (err) => {
      if(err) {
        console.log('Error deleting stack')
      } else {
        console.log('Deleted stack')
      }
    });
  });


program
  .command('create', 'Create a new blog in the cloud.')
  .argument('<title>', 'The title of the blog.')
  .option('-r --region <region>',
          'AWS Region', undefined, 'us-east-1')
  .action((args, options, logger) => {
    const { title } = args;
    const { region } = options;

    createCommand({
      title,
      region
    });
  })

program
  .command('list', 'List all Seehund blogs in AWS account and region')
  .option('-r --region <region>',
          'AWS Region', undefined, 'us-east-1')
  .action((args, options, logger) => {
    const { region } = options;
    listCommand({region});
  });

program
  .command('show', 'Show information about a seehund blog')
  .argument('<blogName>', 'Blog to show')
  .option('-r --region <region>',
          'AWS Region', undefined, 'us-east-1')
  .action((args, options, logger) => {
    const { blogName } = args;
    const { region } = options;
    showCommand({blogName, region});
  });

program
  .command('show_api_url', 'Show information about a seehund blog')
  .argument('<blogName>', 'Blog to show')
  .option('-r --region <region>',
          'AWS Region', undefined, 'us-east-1')
  .action((args, options, logger) => {
    const { blogName } = args;
    const { region } = options;
    getApiUrl({blogName, region}, (err, apiUrl) => {
      if(err) {
        console.log('error getting api url')
        console.info(err);
      } else {
        console.log(`API URL: ${apiUrl}`)
      }
    });
  });


program
  .command('destroy_bucket', 'Destroy the web bucket')
  .argument('<blogName>', 'Blog to destroy')
  .option('-r --region <region>',
          'AWS Region', undefined, 'us-east-1')
  .action((args, options, logger) => {
    const { blogName } = args;
    const { region } = options;
    deleteBucketCommand({blogName, region}, (err) => {
      if(err) {
        console.log('Error deleting bucket')
      } else {
        console.log('Deleted bucket')
      }
    });
  });


program
  .command('destroy', 'Destroy all cloud resources')
  .argument('<blogName>', 'Blog to destroy')
  .option('-r --region <region>',
          'AWS Region', undefined, 'us-east-1')
  .action((args, options, logger) => {
    const { blogName } = args;
    const { region } = options;
    destroyCommand({blogName, region}, (err) => {
      if(err) {
        console.log('Error destroying blog')
      } else {
        console.log('Destroyed blog')
      }
    });
  });

program
  .command('install_api', 'Installs the API')
  .argument('<blogName>', 'Blog name to install')
  .option('-r --region <region>',
          'AWS Region', undefined, 'us-east-1')
  .action((args, options, logger) => {
    const { blogName } = args;
    const { region } = options;
    installApiCommand({blogName, region});
  });

program
  .command('build_admin', 'Builds the admin system with webpack, supplying cloud resource configuration')
  .argument('<blogName>', 'Blog name to build admin for')
  .option('-r --region <region>',
          'AWS Region', undefined, 'us-east-1')
  .action((args, options, logger) => {
    const { blogName } = args;
    const { region } = options;
    const appClientId = '6fj9o9lt8j4hqn9ed46s3vheth';
    const userPoolId = 'us-east-1_V9cE8RZWG';
    buildAdminCommand({blogName, appClientId, userPoolId});
  });

program
  .command('upload_admin', 'Uploads the admin system to the web bucket')
  .argument('<blogName>', 'Blog name to upload admin for')
  .option('-r --region <region>',
          'AWS Region', undefined, 'us-east-1')
  .action((args, options, logger) => {
    const { blogName } = args;
    const { region } = options;
    const bucketName = 'this-is-the-future-fk4g3m2j5';
    uploadAdminCommand({blogName, bucketName});
  });

program
  .command('create_admin_user', 'Uploads the admin system to the web bucket')
  .argument('<blogName>', 'Blog name to create admin user for')
  .option('-r --region <region>',
          'AWS Region', undefined, 'us-east-1')
  .action((args, options, logger) => {
    const { blogName } = args;
    const { region } = options;
    createAdminUserCommand({blogName, region}, (err, data) => {
      if(err) {
        console.log('Error creating admin user')
      } else {
        console.log('Created admin user')
      }
    });
  });


program.parse(process.argv)


